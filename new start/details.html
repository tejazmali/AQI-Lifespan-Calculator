<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Air Pollution Impact</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,300" rel="stylesheet">
  <style>
    /* Global Dark Theme */
    body {
      margin: 0;
      padding: 0;
      background-color: #030712; /* Very dark background */
      color: #FAFAFA;           /* Light text */
      font-family: "Inter", sans-serif;
    }

    /* Position the icon in the top left corner */
    .back-icon {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 30px;
      color: #ffffff;
      cursor: pointer;
    }

    .container-details {
      width: 100%;
      max-width: 400px;
      margin: 60px auto; /* Center horizontally with auto margins */
      padding: 20px;
      background: #1f1f1f;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      text-align: center;
      margin-top: 100px;
    }

    .container-details h1 {
      margin-top: 0;
      font-weight: 400;
      font-size: 24px;
      color: #ffffff;
    }

    .container-details p {
      color: #aaaaaa;
      font-size: 14px;
      margin-bottom: 30px;
    }

    /* Input styles */
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .input-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      color: #f0f0f0;
    }

    .input-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #444;
      border-radius: 6px;
      font-size: 16px;
      background-color: #2c2c2c;
      color: #ffffff;
      box-sizing: border-box;
    }

    /* Button styles */
    button {
      width: 100%;
      padding: 12px;
      background: #ffffff;
      border: none;
      color: #030712;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s ease;
      margin-bottom: 20px;
    }

    button:hover {
      background: #cbcbcb;
    }
  </style>
</head>
<body>
  
  <div id="header"></div>
  <!-- Google Material Icon for Arrow Back (Positioned to the left) -->

  <div class="container-details">
    <h1 id="stateHeading">Selected State</h1>
    <p>Enter your details to calculate air pollution impact</p>
    
    <div class="input-group">
      <label for="ageInput">Your Age</label>
      <input type="number" id="ageInput" placeholder="e.g. 39" min="0" step="1">
    </div>
    
    <div class="input-group">
      <label for="yearsLived">Years Living in the City</label>
      <input type="number" id="yearsLived" placeholder="e.g. 10" min="0" step="1">
    </div>

    <button id="calculateBtn">Calculate Impact</button>
  </div>

  <script>
    // Get query params for state name & coordinates from index.html (if applicable)
    const urlParams = new URLSearchParams(window.location.search);
    const stateName = urlParams.get('state') || "Unknown State";
    const lat = urlParams.get('lat');
    const lon = urlParams.get('lon');

    // Update heading with selected state
    document.getElementById('stateHeading').innerText = stateName;

    // On "Calculate Impact", fetch data, do calculations, then redirect
    document.getElementById('calculateBtn').addEventListener('click', function() {
      const age = parseFloat(document.getElementById('ageInput').value);
      const yearsLived = parseFloat(document.getElementById('yearsLived').value);

      if (isNaN(age) || age < 0) {
        alert("Please enter a valid age.");
        return;
      }
      if (isNaN(yearsLived) || yearsLived < 0) {
        alert("Please enter valid years for living in the city.");
        return;
      }
      if (!lat || !lon) {
        alert("Coordinates not found!");
        return;
      }

      // Replace with your actual OpenWeather API key
      const apiKey = '6c07e32e91538d3ad6491ccda66aac57';
      const url = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${apiKey}`;

      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.json();
        })
        .then(data => {
          // Extract pollutant components
          const comp = data.list[0].components;
          const pm25 = comp.pm2_5;
          const pm10 = comp.pm10;
          const no2 = comp.no2;
          const so2 = comp.so2;
          const o3  = comp.o3;
          const co  = comp.co;

          // Calculate AQI for PM2.5
          let aqi_pm25 = 0;
          if (pm25 <= 12.0) {
            aqi_pm25 = (50 / 12.0) * pm25;
          } else if (pm25 <= 35.4) {
            aqi_pm25 = ((100 - 51) / (35.4 - 12.1)) * (pm25 - 12.1) + 51;
          } else if (pm25 <= 55.4) {
            aqi_pm25 = ((150 - 101) / (55.4 - 35.5)) * (pm25 - 35.5) + 101;
          } else if (pm25 <= 150.4) {
            aqi_pm25 = ((200 - 151) / (150.4 - 55.5)) * (pm25 - 55.5) + 151;
          } else if (pm25 <= 250.4) {
            aqi_pm25 = ((300 - 201) / (250.4 - 150.5)) * (pm25 - 150.5) + 201;
          } else {
            aqi_pm25 = pm25; // a rough fallback
          }

          // Calculate AQI for PM10
          let aqi_pm10 = 0;
          if (pm10 <= 54) {
            aqi_pm10 = (50 / 54) * pm10;
          } else if (pm10 <= 154) {
            aqi_pm10 = ((100 - 51) / (154 - 55)) * (pm10 - 55) + 51;
          } else if (pm10 <= 254) {
            aqi_pm10 = ((150 - 101) / (254 - 155)) * (pm10 - 155) + 101;
          } else if (pm10 <= 354) {
            aqi_pm10 = ((200 - 151) / (354 - 255)) * (pm10 - 255) + 151;
          } else {
            aqi_pm10 = pm10; // a rough fallback
          }

          // Overall AQI is max of the two
          const overallAQI = Math.round(Math.max(aqi_pm25, aqi_pm10));

          // Estimate "Cigarette Equivalents" from PM2.5
          // Very rough approach: pm25/10 => cigs per day
          const cigsPerDay = (pm25 / 10).toFixed(2);
          const cigsPerYear = Math.round(cigsPerDay * 365);

          // Lifespan Reduction
          // Example approach:
          let RR = pm25 > 10 ? 1 + 0.06 * (pm25 - 10) : 1;
          let AF = RR > 1 ? (RR - 1) / RR : 0;
          let RLE = age < 80 ? 80 - age : Math.max(85 - age, 0);
          let exposureFraction = Math.min(yearsLived / 40, 1);
          let estimatedYLL = AF * RLE * exposureFraction;       // in years
          let estimatedYLLDays = (estimatedYLL * 365).toFixed(0);

          // Simple "status" label for AQI
          let aqiStatus = "Good";
          if (overallAQI > 50 && overallAQI <= 100) aqiStatus = "Moderate";
          else if (overallAQI > 100 && overallAQI <= 150) aqiStatus = "Unhealthy for Sensitive Groups";
          else if (overallAQI > 150 && overallAQI <= 200) aqiStatus = "Unhealthy";
          else if (overallAQI > 200 && overallAQI <= 300) aqiStatus = "Very Unhealthy";
          else if (overallAQI > 300) aqiStatus = "Hazardous";

          // Build results object to pass to results.html
          const results = {
            stateName: stateName,
            aqi: overallAQI,
            aqiStatus: aqiStatus,
            cigsPerDay: cigsPerDay,
            cigsPerYear: cigsPerYear,
            pm25: pm25,
            pm10: pm10,
            no2: no2,
            so2: so2,
            o3:  o3,
            co:  co,
            daysLost: estimatedYLLDays,
            yearsLost: estimatedYLL.toFixed(2),
            rawData: data  // entire API JSON
          };

          // Encode results as JSON in query param
          const queryString = encodeURIComponent(JSON.stringify(results));
          window.location.href = `results.html?data=${queryString}`;
        })
        .catch(error => {
          alert("Error: " + error.message);
        });
    });
  </script>
  <script src="/new start/script.js"></script>
</body>
</html>
